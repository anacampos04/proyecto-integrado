rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ===== USUARIOS =====
    // - Cualquier usuario autenticado puede LEER perfiles (necesario para búsqueda de amigos)
    // - Solo el propietario puede CREAR/ELIMINAR su documento
    // - Updates: el propietario puede actualizar TODO, otros solo pueden modificar el array 'amigos'
    match /usuarios/{userId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.auth.uid == userId;
      allow delete: if request.auth != null && request.auth.uid == userId;
      allow update: if request.auth != null && (
        // El propietario puede actualizar su propio documento completamente
        request.auth.uid == userId ||
        // Permitir añadir/eliminar en el array 'amigos' (para operaciones bidireccionales)
        // Solo se puede modificar el campo 'amigos'
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['amigos'])
      );
    }

    // ===== SOLICITUDES DE AMISTAD =====
    // - El remitente puede crear solicitudes
    // - El destinatario puede leer y actualizar (aceptar/rechazar) sus solicitudes
    // - El remitente puede leer sus solicitudes enviadas
    // - Permitir queries para verificar solicitudes existentes
    match /solicitudesAmistad/{solicitudId} {
      allow create: if request.auth != null && request.resource.data.de == request.auth.uid;

      // Permitir leer documentos específicos si eres el remitente o destinatario
      allow get: if request.auth != null && (
        resource.data.de == request.auth.uid ||
        resource.data.para == request.auth.uid
      );

      // Permitir queries/list - esto es necesario para verificar solicitudes existentes
      allow list: if request.auth != null;

      // Permitir update si:
      // 1. Eres el destinatario (para aceptar/rechazar)
      // 2. Eres el remitente Y solo modificas el estado a ACEPTADA (aceptación automática)
      allow update: if request.auth != null && (
        resource.data.para == request.auth.uid ||
        (resource.data.de == request.auth.uid &&
         request.resource.data.estado == 'ACEPTADA')
      );

      allow delete: if request.auth != null && (
        resource.data.de == request.auth.uid ||
        resource.data.para == request.auth.uid
      );
    }

    // ===== GRUPOS / RONDAS =====
    // - Cualquier usuario autenticado puede CREAR grupos
    // - Solo los MIEMBROS pueden LEER el grupo
    // - ACTUALIZAR: el creador puede actualizar todo, los miembros pueden actualizar su configuración
    // - Cualquier MIEMBRO puede ELIMINAR el grupo y todo su contenido
    match /grupos/{groupId} {
      allow create: if request.auth != null;
      allow read: if request.auth != null && request.auth.uid in resource.data.miembros;
      allow update: if request.auth != null && (
        // El creador puede actualizar todo
        request.auth.uid == resource.data.creadoPor ||
        // Los miembros pueden actualizar solo su configuración y los filtros/estado cuando todos configuren
        (request.auth.uid in resource.data.miembros &&
         // Verificar que solo se modifican campos permitidos
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['configuraciones', 'estado', 'filtros', 'filtrosActualizadosEn']))
      );
      // CAMBIADO: Cualquier miembro puede eliminar el grupo
      allow delete: if request.auth != null && request.auth.uid in resource.data.miembros;

      // Votos dentro de grupos (subcolección) - NO SE USAN, los votos están en /votos global
      match /votos/{voteId} {
        allow create: if request.auth != null && request.auth.uid in get(/databases/$(database)/documents/grupos/$(groupId)).data.miembros;
        allow read: if request.auth != null && request.auth.uid in get(/databases/$(database)/documents/grupos/$(groupId)).data.miembros;
        allow update: if request.auth != null && resource.data.idUsuario == request.auth.uid;
        // CAMBIADO: Cualquier miembro del grupo puede eliminar votos al borrar el grupo
        allow delete: if request.auth != null && request.auth.uid in get(/databases/$(database)/documents/grupos/$(groupId)).data.miembros;
      }

      // Matches dentro de grupos (subcolección)
      match /matches/{matchId} {
        allow create: if request.auth != null && request.auth.uid in get(/databases/$(database)/documents/grupos/$(groupId)).data.miembros;
        allow read: if request.auth != null && request.auth.uid in get(/databases/$(database)/documents/grupos/$(groupId)).data.miembros;
        allow update: if request.auth != null && request.auth.uid in get(/databases/$(database)/documents/grupos/$(groupId)).data.miembros;
        // CAMBIADO: Cualquier miembro del grupo puede eliminar matches al borrar el grupo
        allow delete: if request.auth != null && request.auth.uid in get(/databases/$(database)/documents/grupos/$(groupId)).data.miembros;
      }
    }

    // ===== VOTOS GLOBALES =====
    // - Los usuarios pueden crear y leer votos
    // - Solo el propietario puede actualizar/eliminar sus votos
    // - Excepción: al eliminar un grupo, cualquier miembro puede eliminar votos de ese grupo
    match /votos/{votoId} {
      allow create: if request.auth != null;
      allow read: if request.auth != null;
      allow update: if request.auth != null && resource.data.idUsuario == request.auth.uid;
      // CAMBIADO: Permitir eliminar si eres el dueño del voto O si eres miembro del grupo asociado
      allow delete: if request.auth != null && (
        resource.data.idUsuario == request.auth.uid ||
        // Permitir si el voto pertenece a un grupo donde el usuario es miembro
        (exists(/databases/$(database)/documents/grupos/$(resource.data.grupoId)) &&
         request.auth.uid in get(/databases/$(database)/documents/grupos/$(resource.data.grupoId)).data.miembros)
      );
    }

    // ===== NOTIFICACIONES =====
    // - Los usuarios autenticados pueden CREAR notificaciones
    // - Cloud Functions procesa y elimina estos documentos
    // - NO permitir lectura directa (las notificaciones se envían vía FCM)
    match /notificaciones/{notifId} {
      allow create: if request.auth != null;
      allow read: if false; // Solo Cloud Functions debe leer
      allow update: if false;
      allow delete: if false; // Solo Cloud Functions elimina después de procesar
    }
  }
}
